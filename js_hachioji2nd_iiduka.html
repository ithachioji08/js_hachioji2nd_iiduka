<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<title>最終課題_八王子第二_飯塚</title>
</head>
<body>
	<div id="package">
		<div id="musicName"></div>
		<div id="soundName"></div>
		<input type="button" id="auto" value="自動演奏">
		<input type="button" id="stop" value="演奏停止">
		<ul id ="keyboard">
			<li>ド</li>
			<li>レ</li>
			<li>ミ</li>
			<li>ファ</li>
			<li>ソ</li>
			<li>ラ</li>
			<li>シ</li>
			<li>ド</li>
		</ul>
		<div id="terop"></div>
	</div>
    
	<style>
		#package{
			width:250px;
			text-align: center;
		}
		#soundName{
			width:100%;
			height:80px;
			line-height: 80px;
			background-color: bisque;
			text-align: center;
		}

		#auto{
			margin:0 auto;
		}
		#stop{
			margin:0 auto;
			display: none;
		}

		#keyboard{
			width: 100%;
			display: flex;
			align-items: center;
			padding: 0;
		}
		li{
			border:solid;
			border-width: 2px;
			list-style: none;
			width:100%;
			height:55px;
		}
	</style>
    <script>
		
        $('#keyboard li').on('click', function(){
			let index = $('#keyboard li').index($(this));
			let text  = $('#keyboard li')[index].innerText;
           	$('#soundName').text(text);
			setTimeout(()=>{
				$('#soundName').text('');
			},1000);
		});

		$('#auto').click(()=>{
			$('#auto').hide();
			$('#stop').show();
			const score = getRondomScore();
			startAutoplay(score);
		});

		function getRondomScore(){
			if(Math.random() > 0.5){
				$('#musicName').text("自動演奏中です：きらきら星");
				return getTwinkleStar();
			}else{
				$('#musicName').text("自動演奏中です：チューリップ");
				return getChoolip();
			};
		}

		function startAutoplay(score){
			const loopId = playScore(score);
			
			setTimeout(()=>{stop()},score[score.length-1].time);
			$('#stop').click(()=>{
				loopId.forEach((id)=>{
					clearTimeout(id);
				});
				stop();
			});
		};

		
		function playScore(score){
			let loopId = [];
			score.forEach((element,i,array) => {
				let time;
				if (i==0){
					time = 0;
				}else{
					time = array[i-1].time;
				}
				loopId.push(
					setTimeout(()=>{
						$('#soundName').text(element.scale);
						$('#terop').text($('#terop').text() + element.lyric);
					},time)	
				);
			});
			return loopId;
		}

		function stop(){
			$('#musicName').text("");
			$('#soundName').text('');
			$('#terop').text("");
			$('#auto').show();
			$('#stop').hide();
		};

		function getTwinkleStar(){
			//課題の楽譜をコピペして文字列操作で演奏できるような状態にする。
			const scales ='ド(0.5秒)休符(0.5秒)ド(0.5秒)休符(0.5秒)ソ(0.5秒)休符(0.5秒)' +
				'ソ(0.5秒)休符(0.5秒)ラ(0.5秒)休符(0.5秒)ラ(0.5秒)休符(0.5秒)ソ(2秒)ファ(0.5秒)' +
				'休符(0.5秒)ファ(0.5秒)休符(0.5秒)ミ(0.5秒)休符(0.5秒)ミ(0.5秒)休符(0.5秒)レ(0.5秒)' +
				'休符(0.5秒)レ(0.5秒)休符(0.5秒)ド(2秒)ソ(0.5秒)休符(0.5秒)ソ(0.5秒)休符(0.5秒)'+
				'ファ(0.5秒)休符(0.5秒)ファ(0.5秒)休符(0.5秒)ミ(0.5秒)休符(0.5秒)ミ(0.5秒)' +
				'休符(0.5秒)レ(2秒)ソ(0.5秒)休符(0.5秒)ソ(0.5秒)休符(0.5秒)ファ(0.5秒)'+
				'休符(0.5秒)ファ(0.5秒)休符(0.5秒)ミ(0.5秒)休符(0.5秒)ミ(0.5秒)休符(0.5秒)'+
				'レ(2秒)ド(0.5秒)休符(0.5秒)ド(0.5秒)休符(0.5秒)ソ(0.5秒)休符(0.5秒)' +
				'ソ(0.5秒)休符(0.5秒)ラ(0.5秒)休符(0.5秒)ラ(0.5秒)休符(0.5秒)ソ(2秒)' +
				'ファ(0.5秒)休符(0.5秒)ファ(0.5秒)休符(0.5秒)ミ(0.5秒)休符(0.5秒)ミ(0.5秒)' +
				'休符(0.5秒)レ(0.5秒)休符(0.5秒)レ(0.5秒)休符(0.5秒)ド(4秒)';
			const lyrics = 'きらきらひかるおそらのほしよまばたきしてはみんなをみてるきらきらひかるよぞらのほしよ';

			return getNotes(scales,lyrics);
		};

		function getChoolip(){
			const scales = 'ド(0.5秒)レ(0.5秒)ミ(1秒)ド(0.5秒)レ(0.5秒)ミ(1秒)'+
				'ソ(0.5秒)ミ(0.5秒)レ(0.5秒)ド(0.5秒)レ(0.5秒)ミ(0.5秒)レ(1秒)'+
				'ド(0.5秒)レ(0.5秒)ミ(1秒)ド(0.5秒)レ(0.5秒)ミ(1秒)'+
				'ソ(0.5秒)ミ(0.5秒)レ(0.5秒)ド(0.5秒)レ(0.5秒)ミ(0.5秒)ド(1秒)'+
				'ソ(0.25秒)休符(0.25秒)ソ(0.25秒)休符(0.25秒)ミ(0.25秒)休符(0.25秒)'+
				'ソ(0.25秒)休符(0.25秒)ラ(0.25秒)休符(0.25秒)ラ(0.25秒)休符(0.25秒)'+
				'ソ(1秒)ミ(0.25秒)休符(0.25秒)ミ(0.25秒)休符(0.25秒)レ(0.25秒)'+
				'休符(0.25秒)レ(0.25秒)休符(0.25秒)ド(4秒)';
			//音符ひとつで複数文字の仕様上、配列にしないといけない。
			const lyrics = ['さ','い','た','さ','い','た','チュー','リッ','プ','の','は','な','が','な','らん',
				'だ','な','らん','だ','あ','か','し','ろ','き','い','ろ','ど','の','は','な','み','て','も','き','れ','い','だ','な'];
			return getNotes(scales,lyrics);
		};

		function getNotes(scales,lyrics){
			let notes      = [];
			let timeSome   = 0;
			let scaleArray = scales.split(')');
			let lyricCount = -1;
			let scale;
			let lyric;
			scaleArray.pop();  //splitの都合上、最後に空っぽのデータが出来るので削除
			scaleArray.forEach(scale=>{
				let splitedScale = scale.split('秒')[0].split('(');
				if (splitedScale[0] == '休符'){
					scale = '';
					lyric = '-';
				}else{
					scale = splitedScale[0];
					lyricCount++;
					lyric = lyrics[lyricCount]
				}
				timeSome+= parseFloat(splitedScale[1]) *1000;
				notes.push(new Note(scale,timeSome,lyric));
			});
			return notes;
		};

		class Note{
			constructor(scale,time,lyric){
				this.scale = scale;
				this.time  = time;
				this.lyric = lyric;
			}
		};


    </script>
</body>
</html>